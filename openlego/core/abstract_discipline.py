#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Copyright 2018 D. de Vries

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

This file contains the definition of the AbstractDiscipline interface class.
"""
from __future__ import absolute_import, division, print_function

import abc
import inspect
import os
from typing import Optional

from six import string_types
from cached_property import cached_property

from openlego.partials.partials import Partials


class AbstractDiscipline(object):
    """Defines the common interface for all disciplines within ``OpenLEGO``."""
    __metaclass__ = abc.ABCMeta

    @property
    def name(self):
        # type: () -> str
        """:obj:`str`: Name of this discipline."""
        return self.__class__.__name__

    @property
    def path(self):
        # type: () -> str
        """:obj:`str`: Path at which this discipline resides."""
        return os.path.dirname(inspect.getfile(self.__class__))

    @property
    def in_file(self):
        # type: () -> str
        """:obj:`str`: Path of the template input XML file of this discipline."""
        return self._get_in_file_path(self.path)

    def _get_in_file_path(self, folder):
        return os.path.join(folder, self.name + '-input.xml')

    @cached_property
    def in_file_content(self):
        """
        Either the path to the input file, or if this does not exist the content generated by generate_input_xml.

        :rtype: str
        """
        in_file_path = self.in_file
        if os.path.exists(in_file_path):
            return in_file_path
        return self.generate_input_xml()

    @property
    def out_file(self):
        # type: () -> str
        """:obj:`str`: Path of the template output XML file of this discipline."""
        return self._get_out_file_path(self.path)

    def _get_out_file_path(self, folder):
        return os.path.join(folder, self.name + '-output.xml')

    @cached_property
    def out_file_content(self):
        """
        Either the path to the output file, or if this does not exist the content generated by generate_output_xml.

        :rtype: str
        """
        out_file_path = self.out_file
        if os.path.exists(out_file_path):
            return out_file_path
        return self.generate_output_xml()

    @property
    def partials_file(self):
        # type: () -> str
        """:obj:`str`: Path of the partials XML file of this discipline."""
        return self._get_partials_file_path(self.path)

    def _get_partials_file_path(self, folder):
        return os.path.join(folder, self.name + '-partials.xml')

    @property
    def supplies_partials(self):
        # type: () -> bool
        """Set to True to indicate this discipline supplies gradients."""
        return False

    @cached_property
    def partials_file_content(self):
        """
        Either the path to the partials file, or if this does not exist the content generated by generate_partials_xml.
        If this component does not supply partials, None is returned.

        :rtype: str|None
        """
        if not self.supplies_partials:
            return

        partials_file_path = self.partials_file
        if os.path.exists(partials_file_path):
            return partials_file_path
        return self.generate_partials_xml()

    @abc.abstractmethod
    def generate_input_xml(self):
        # type: () -> string_types
        """Generate the template input XML for this discipline.

        This method should be implemented to define the input template of a specific discipline.

        Returns
        -------
            string_types
                String representation of the template input XML.
        """
        raise NotImplementedError

    @abc.abstractmethod
    def generate_output_xml(self):
        # type: () -> string_types
        """Generate the template output XML for this discipline.

        This method should be implemented to define the output template of a specific discipline.

        Returns
        -------
            string_types
                String representation of the template output XML file.
        """
        raise NotImplementedError

    def generate_partials_xml(self):
        # type: () -> string_types
        """Generate the template partials XML file for this discipline.

        This method should be implemented to define for which inputs this discipline can provide
        the sensitivities.

        Returns
        -------
            string_types
                String representation of the template partials XML file.
        """
        return Partials().get_string()

    def deploy(self, target_folder=None):
        # type: (Optional[str]) -> None
        """Deploy this discipline's template in-/output, partials XML files and its information
        JSON file."""
        if target_folder is None:
            target_folder = self.path

        with open(self._get_in_file_path(target_folder), 'wb') as f:
            f.write(self.generate_input_xml())
        with open(self._get_out_file_path(target_folder), 'wb') as f:
            f.write(self.generate_output_xml())
        if self.supplies_partials:
            with open(self._get_partials_file_path(target_folder), 'wb') as f:
                f.write(self.generate_partials_xml())

    @staticmethod
    @abc.abstractmethod
    def execute(in_file, out_file):
        # type: (str, str) -> None
        """Execute this discipline with the given in- and output XML files.

        This method should be implemented to define the execution of a specific discipline.

        Parameters
        ----------
            in_file : str
                Path to the input XML file.

            out_file : str
                Path to the output XML file.
        """
        raise NotImplementedError

    @staticmethod
    def linearize(in_file, partials_file):
        # type: (str, str) -> None
        """Compute the sensitivities of a given input XML file and write them to a given partials
        XML file.

        This method should be implemented to define the linearization of a specific discipline. By
        default a discipline is considered a 'black box', and no sensitivities are provided.

        Parameters
        ----------
            in_file : str
                Path to the input XML file.

            partials_file : str
                Path to the sensitivities XML file.
        """
        Partials().write(partials_file)

    def cleanup(self):
        """
        Called after running the driver. Similar to the System.cleanup() function of OpenMDAO.

        :return:
        """
